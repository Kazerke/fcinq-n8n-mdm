{
  "createdAt": "2025-10-17T11:33:43.738Z",
  "updatedAt": "2025-10-23T18:50:40.000Z",
  "id": "WgDlTroMpNzmsHA5",
  "name": "POC Maisons du Monde",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4192,
        832
      ],
      "id": "586d294f-7c16-411f-b948-bf92022038f7",
      "name": "Wait1",
      "webhookId": "c4aa2b7e-c06b-4883-8caf-d5afe04892dd"
    },
    {
      "parameters": {
        "url": "=https://queue.fal.run/fal-ai/nano-banana/requests/{{ $('API Fal.ai').item.json.request_id }}/status",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4336,
        832
      ],
      "id": "92cde25c-74b8-488c-ae6e-53e408c70aef",
      "name": "Get status",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FPCGtWCwWzLspdMJ",
          "name": "Fal.ai"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://queue.fal.run/fal-ai/nano-banana/requests/{{ $json.request_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4656,
        816
      ],
      "id": "45eaddb7-d206-4d8c-8e20-4a9f294c6e14",
      "name": "Get url image",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FPCGtWCwWzLspdMJ",
          "name": "Fal.ai"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.images[0].url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4928,
        976
      ],
      "id": "a0a44320-5ef1-4add-a3ac-43f542d3e150",
      "name": "Get image"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        2688,
        832
      ],
      "id": "0d378d5e-81d7-4728-8ad6-f7ca58e7626f",
      "name": "When clicking 'Execute workflow'"
    },
    {
      "parameters": {
        "url": "https://api.pinterest.com/v5/boards/509188370309616781/pins",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2880,
        832
      ],
      "id": "cd514e31-0405-494c-9d1d-918348c2eb42",
      "name": "Get pins from board",
      "credentials": {
        "oAuth2Api": {
          "id": "Zz6vRIt65aHrYBxC",
          "name": "Pinterest prod"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Hashtags à rechercher (en minuscules)\nconst hashtags = ['#maisonsdumonde'];\n\n// Récupération des pins\nconst pins = $input.first().json.items || [];\n\n// Filtre ceux contenant au moins un hashtag attendu\nconst filteredPins = pins.filter(pin => {\n  const desc = (pin.description || '').toLowerCase();\n  return hashtags.some(tag => desc.includes(tag));\n});\n\nif (filteredPins.length === 0) {\n  return [];\n}\n\n// Trie par date de création décroissante (pin.created_at est ISO 8601)\nfilteredPins.sort((a, b) => {\n  const dateA = new Date(a.created_at || 0).getTime();\n  const dateB = new Date(b.created_at || 0).getTime();\n  return dateB - dateA;\n});\n\n// Ne renvoie que le pin le plus récent\nconst latestPin = filteredPins[0];\n\nreturn [{ json: latestPin }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3072,
        832
      ],
      "id": "d51e81b2-b442-41a0-b3ff-3097a244668f",
      "name": "Get tagged pin"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent AI chargé de décorer une pièce dont on t'a fourni une simple photo [ {{ $json.photo }} ].\n\nAnalyse le titre et la description fournis [ {{ $json.title }}, {{ $json.description }} ].\nDéduis-en la pièce à décorer.\nDéduis-en le type d'ambiance ou le style de décoration voulu.\n\nA partir du type de pièce et de style que tu déduis, sélectionne une liste de 6 à 9 produits qui correspondent dans l'outil Catalogue MDM1 fourni.\nPour faire ta sélection, tu t'appuieras sur les colonnes \"Nom du produit\" et \"Description\".\nEvite de sélectionner 2 produits du même type (canapé, fauteuil).\nInclus dans ta sélection des produits qui vont habiller le sol et les murs.\nS'il te reste de la place, tu peux ajouter des produits type vase, horloge, bouts de canapé...\n\nSi tu sélectionnes moins de 6 produits de cette façon, tu peux compléter la liste avec d'autres produits du catalogue. Jamais plus de de 9 produits au total.\n\nGénère aussi une courte phrase enthousiaste disant que tu viens de décorer leur pièce.\nA la fin de cette phrase, saute une ligne et liste ensuite les produits sélectionné.\nPour chaque produit, indique son nom, puis à la ligne, son url.\nSaute ensuite une ligne.\nLa phrase + les liens ne peuvent pas dépasser 800 caractères au total et vont constituer une légende pour une pin Pinterest.\n\n## Format de sortie\n\nJe veux récupérer un objet json composé comme suit :\n{\n  \"photos\": [visuel de la piece, visuel du produit, ...],\n  \"products\": [\n    {\n      \"title\": nom du produit,\n      \"url\" : short url du produit\n    },\n    ...\n  ],\n  \"style\": style de la pièce,\n  \"legend\": légende générée\n}\n\nJe veux que le 1er item du tableau \"photos\" soit la photo de la pièce fournie au départ [ {{ $json.photo }} ]. Insère-la au début du tableau si tu ne l'as pas déjà fait.\nJe ne veux rien d'autre que cette objet json dans ta réponse.",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Tu es un agent IA spécialisé en décoration intérieure pour Maisons du Monde. Processus attendu :\n1. Analyse le titre, la description et la photo fournis pour identifier la pièce et l’ambiance recherchée.\n2. Lorsque tu as besoin du catalogue, appelle l’outil « Catalogue MDM1 ». Les paramètres du document sont déjà définis : passe toujours un objet JSON en arguments (par exemple `{}` ou `{ \"filters\": {...} }`) et n’envoie jamais un tableau vide. Si aucun filtre ne s’impose, utilise `{}`.\n3. Utilise les données récupérées pour sélectionner 6 à 9 produits variés et complémentaires (mobilier, luminaires, revêtements, accessoires).\n4. Compose la légende Pinterest en respectant toutes les contraintes de longueur et de format, puis prépare l’objet JSON final.\n5. Une fois ton raisonnement terminé, renvoie uniquement l’objet JSON attendu ; n’ajoute aucun texte autour.\nRéfléchis étape par étape et exploite le catalogue autant que nécessaire, mais ne partage pas tes pensées intermédiaires dans la réponse finale."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        3456,
        832
      ],
      "id": "3ee6691d-33a1-4c92-8066-6dd0b5692751",
      "name": "Deco Agent",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "11H-HJseYM6dOFzGVEs6U50QoTaddXp-E9rdRYrCupjs",
          "mode": "list",
          "cachedResultName": "MDM",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11H-HJseYM6dOFzGVEs6U50QoTaddXp-E9rdRYrCupjs/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Catalogue",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11H-HJseYM6dOFzGVEs6U50QoTaddXp-E9rdRYrCupjs/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        3616,
        1040
      ],
      "id": "119bf7a3-6740-453c-8774-b0d8e20031a0",
      "name": "Catalogue MDM1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "jsZEtBBiDLYMHNco",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "de78fb69-82e0-46fd-9cdf-8ea2d2bcf2db",
              "name": "title",
              "value": "={{ $json.title }}",
              "type": "string"
            },
            {
              "id": "28976aa1-26f7-4f2d-9ceb-eccb17609a5b",
              "name": "description",
              "value": "={{ $json.description }}",
              "type": "string"
            },
            {
              "id": "fd27a576-9ea0-4cff-b342-7e13524c29a0",
              "name": "photo",
              "value": "={{ $json.media.images['1200x'].url }}",
              "type": "string"
            },
            {
              "id": "5cafd3a0-7c3d-4f46-9a72-0df7b0e8842b",
              "name": "pinterestTitle",
              "value": "=(() => {\n  const suffix = ' - \u00e0 la sauce MDM';\n  const baseTitle = `${$json.title || 'Moodboard'}${suffix}`;\n  const normalized = baseTitle.replace(/\\s+/g, ' ').trim();\n  if (normalized.length <= 100) {\n    return normalized;\n  }\n  const slice = normalized.slice(0, 100);\n  const lastSpace = slice.lastIndexOf(' ');\n  const candidate = lastSpace >= 60 ? slice.slice(0, lastSpace) : slice;\n  const trimmed = candidate.trimEnd();\n  return trimmed.length > 0 ? trimmed : slice.trimEnd();\n})()",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3264,
        832
      ],
      "id": "7c3d6f32-24a8-4767-9a7d-4385f8b9cc41",
      "name": "Map Fields for Deco Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9af071f-7196-4eb1-a572-6ea077bc1ed9",
              "name": "prompt",
              "value": "=Interior design ultra-realistic render of the room shown in the first reference photo.\nRespect the exact orientation, dimensions, and architectural features of the room.\n\nUse the furniture pieces from Maisons du Monde catalog shown in the following reference images.\nYou MUST use these specific products without ANY modifications to their:\n- Colors and finishes\n- Shapes and proportions  \n- Materials and textures\n- Design details\n\nArrange these exact pieces naturally in the room with proper:\n- Scale and perspective\n- Spatial relationships\n- Realistic placement\n\nYou may add complementary elements:\n- Plants in ceramic pots\n- Framed art or prints on walls\n- Decorative accents\n\nStyle: {{ $json.style }}\nLighting: Bright natural daylight from windows, sharp and crisp, professional interior photography quality (AD, Elle Decoration standard)\nMood: Aspirational, refined, cozy yet contemporary\nRender quality: Ultra-realistic, rich textures, perfect proportions, magazine-worthy\nCamera: Wide angle from corner showing depth and window",
              "type": "string"
            },
            {
              "id": "40dae0b8-fe83-43ae-b0fd-aa331c65a0c4",
              "name": "image_urls",
              "value": "=  {{ [$json.roomPhoto, $json.moodboardUrl] }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3776,
        832
      ],
      "id": "aec62b60-7b5b-4eb5-b354-8f803871c1e9",
      "name": "Map Fields for Fal"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "33963196-98f9-4627-af93-fe0383f24829",
              "leftValue": "={{ $json.status }}",
              "rightValue": "COMPLETED",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4480,
        832
      ],
      "id": "a9152cdb-b070-432e-aa95-776dc5efaa8e",
      "name": "Image rendered?"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n    \"photos\":[\n       \"https://i.pinimg.com/1200x/ff/cf/1b/ffcf1b4bba3c4330fde3d6824b724279.jpg\",\n       \"https://medias.maisonsdumonde.com/image/upload/f_auto,q_auto/v1/img/canape-nuage-3-4-places-beige-sable-1000-6-29-223233_12.jpg\",\n       \"https://medias.maisonsdumonde.com/image/upload/f_auto,q_auto/v1/img/miroir-rectangulaire-a-moulures-dorees-67x110-1000-10-38-227096_2.jpg\",\n       \"https://medias.maisonsdumonde.com/image/upload/f_auto,q_auto/v1/img/applique-2-globes-en-verre-et-metal-dore-1000-5-31-217044_1.jpg\",\n       \"https://medias.maisonsdumonde.com/image/upload/f_auto,q_auto/v1/img/grand-tapis-style-oriental-tisse-jacquard-beige-et-gris-200x300-1000-14-4-240428_1.jpg\",\n       \"https://medias.maisonsdumonde.com/image/upload/f_auto,q_auto/v1/img/table-basse-ronde-en-manguier-massif-sculpte-et-metal-noir-d71-1000-15-21-186981_1.jpg\"\n    ],\n   \"products\":[\n      {\n         \"title\":\"Lilo - Canapé nuage 3/4 places beige sable\",\n         \"url\":\"https://tinyurl.com/bdf9w93s\"\n      },\n      {\n         \"title\":\"ELISABETH - Miroir rectangulaire à moulures dorées 67x110\",\n         \"url\":\"https://tinyurl.com/4tpvma4n\"\n      },\n      {\n         \"title\":\"Niagara - Applique 2 globes en verre et métal doré\",\n         \"url\":\"https://tinyurl.com/fh5j8j2r\"\n      },\n      {\n         \"title\":\"Venus - Grand tapis style oriental tissé jacquard beige et gris 200x300\",\n         \"url\":\"https://tinyurl.com/any26hnp\"\n      },\n      {\n         \"title\":\"Krishna - Table basse ronde en manguier massif sculpté et métal noir D71\",\n         \"url\":\"https://tinyurl.com/mr7wk7ef\"\n      }\n   ],\n   \"style\": \"Moderne\",\n   \"legend\": \"Je viens de pimper ta pièce\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3760,
        1040
      ],
      "id": "adeac6b5-4777-40b4-9898-5fb83e3c5cf6",
      "name": "JSON Format"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "4bf92164-350b-484d-b287-314acd1293b2",
      "name": "OpenRouter Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3456,
        1040
      ],
      "credentials": {
        "openRouterApi": {
          "id": "z4t9yieEWKhc34kw",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api-sandbox.pinterest.com/v5/pins",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  board_id: \"509188370309616781\",\n  description: $('Data Cleanup').item.json.legend || '',\n  link: \"https://www.maisonsdumonde.com\",\n  media_source: {\n    source_type: \"image_url\",\n    url: $json.images[0].url\n  },\n  title: (() => {\n    const suffix = ' - à la sauce MDM';\n    const baseRaw = $('Map Fields for Deco Agent').item.json.title || $('Get tagged pin').item.json.title || 'Moodboard';\n    const base = `${baseRaw}${suffix}`;\n    const normalized = base.replace(/\s+/g, ' ').trim();\n    if (normalized.length <= 100) {\n      return normalized;\n    }\n    const slice = normalized.slice(0, 100);\n    const lastSpace = slice.lastIndexOf(' ');\n    const candidate = lastSpace >= 60 ? slice.slice(0, lastSpace) : slice;\n    const trimmed = candidate.trimEnd();\n    return trimmed.length > 0 ? trimmed : slice.trimEnd();\n  })()\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4928,
        816
      ],
      "id": "8d3e0d35-cfb3-4b3e-a09e-4b8d219174bd",
      "name": "Publish pin",
      "credentials": {
        "oAuth2Api": {
          "id": "m0DdTAHMNEtrqnxk",
          "name": "Pinterest credentials sandbox"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://queue.fal.run/fal-ai/nano-banana/edit",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "image_urls",
              "value": "={{ $json.image_urls }}"
            },
            {
              "name": "num_images",
              "value": "1"
            },
            {
              "name": "output_format",
              "value": "jpeg"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3984,
        832
      ],
      "id": "a1f6c4b5-3f27-422f-ba76-f456ff6de0a8",
      "name": "API Fal.ai",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FPCGtWCwWzLspdMJ",
          "name": "Fal.ai"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mdm-working",
        "responseMode": "lastNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              }
            ]
          }
        }
      },
      "id": "9f95847c-87aa-4255-adbf-f5879a0ae44b",
      "name": "Launch Demo Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2672,
        1040
      ],
      "webhookId": "c4ddbe4e-844e-4bec-b7f7-c9643172e785"
    },
    {
      "parameters": {
        "jsCode": "\nconst items = $input.all();\n\nconst ensureString = (value) => {\n  if (value === null || value === undefined) {\n    return '';\n  }\n  return typeof value === 'string' ? value : String(value);\n};\n\nconst normalizeLegend = (value, maxLength) => {\n  const original = ensureString(value);\n  if (!original) {\n    return {\n      legend: '',\n      truncated: false,\n      original,\n    };\n  }\n\n  const normalizedBreaks = original replace ???
